<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Efexzium Chat UI</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
    <svg class="starry-background" width="100%" height="100%">
        <pattern id="starPattern" x="0" y="0" width="200" height="200" patternUnits="userSpaceOnUse">
            <circle cx="10" cy="10" r="1" fill="white" />
            <circle cx="50" cy="30" r="0.8" fill="white" />
            <circle cx="90" cy="70" r="1.2" fill="white" />
            <circle cx="130" cy="100" r="0.9" fill="white" />
            <circle cx="170" cy="50" r="1.1" fill="white" />
            <circle cx="30" cy="140" r="1" fill="white" />
            <circle cx="120" cy="180" r="0.8" fill="white" />
            <circle cx="180" cy="130" r="1.2" fill="white" />
        </pattern>
        <rect width="100%" height="100%" fill="url(#starPattern)" />
    </svg>

    <div class="chat-container">
        <div class="header">
            <div class="header-content">
                <div class="hamburger-menu" id="hamburgerMenu">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <div class="header-title">=$=</div>
                <div style="width: 30px;"></div> <!-- Placeholder to balance the header -->
            </div>
        </div>
        <div class="sidebar" id="sidebar">
            <div class="sidebar-content">
                <div class="sidebar-item"><a href="index.html">Home</a></div>
                <div class="sidebar-item"><a href="plans.html">Plans</a></div>
                <div class="sidebar-item"><a href="settings.html">Settings</a></div>
                <div class="sidebar-item"><a href="help.html">Help</a></div>
                <div class="sidebar-item"><a href="RecordTalkingHead.html">Make Talking Head Video</a></div>
            </div>
        </div>
        <div class="message-list" id="messageList">
            <div class="message assistant">
                <div class="message-content">
                    <p>Hello! How can I assist you today?</p>
                </div>
            </div>
        </div>
        <div class="message-input">
            <div class="input-container">
                <button class="btn" id="uploadBtn" aria-label="Upload file">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
                    </svg>
                    <div class="dropdown" id="uploadDropdown">
                        <a href="#" class="dropdown-item">Upload Image</a>
                        <a href="#" class="dropdown-item">Upload Document</a>
                        <a href="#" class="dropdown-item">Upload Audio</a>
                    </div>
                </button>
                <textarea class="input" id="userInput" placeholder="Type your message here..."></textarea>
                <button class="btn" id="sendBtn" aria-label="Send message">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        const textarea = document.querySelector('.input');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadDropdown = document.getElementById('uploadDropdown');
        const hamburgerMenu = document.getElementById('hamburgerMenu');
        const sidebar = document.getElementById('sidebar');
        const sendButton = document.getElementById('sendBtn');
        const messageList = document.getElementById('messageList');
        const userInput = document.getElementById('userInput');

        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            
            const maxHeight = window.innerHeight * 0.35;
            if (this.scrollHeight > maxHeight) {
                this.style.height = maxHeight + 'px';
                this.style.overflowY = 'scroll';
            } else {
                this.style.overflowY = 'hidden';
            }
        });

        window.addEventListener('resize', function() {
            const event = new Event('input');
            textarea.dispatchEvent(event);
        });

        uploadBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            uploadDropdown.classList.toggle('show');
        });

        document.addEventListener('click', function(e) {
            if (!uploadBtn.contains(e.target)) {
                uploadDropdown.classList.remove('show');
            }
        });

        uploadDropdown.addEventListener('click', function(e) {
            if (e.target.classList.contains('dropdown-item')) {
                e.preventDefault();
                console.log('Selected:', e.target.textContent);
                uploadDropdown.classList.remove('show');
            }
        });

        hamburgerMenu.addEventListener('click', function() {
            sidebar.classList.toggle('open');
        });

        document.addEventListener('click', function(e) {
            if (!hamburgerMenu.contains(e.target) && !sidebar.contains(e.target)) {
                sidebar.classList.remove('open');
            }
        });

        sendButton.addEventListener('click', sendMessage);

        function getMonthlyGoal() {
            return localStorage.getItem('monthlyGoal') || '';
        }

    async function sendMessage() {
        const userMessage = userInput.value.trim();
        if (!userMessage) return;

        // Add user message to UI
        addMessageToUI('user', userMessage);
        userInput.value = '';

        // Get the monthly goal
        const monthlyGoal = getMonthlyGoal();

        // Call API
        try {
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": "Bearer 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",
                    "HTTP-Referer": "http://localhost", // Replace with your actual site URL
                    "X-Title": "Efexzium Chat", // Replace with your actual site name
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    "model": "meta-llama/llama-3.1-8b-instruct:free",
                    "messages": [
                        {"role": "system", "content": `The user's monthly goal is: ${monthlyGoal}`},
                        {"role": "system", "content": `If the users monthly goal is not set tell the user to go to settings and set his goal. if its set ignore this.`},
                        {"role": "user", "content": userMessage},
                    ],
                })
            });

            const data = await response.json();
            const aiMessage = data.choices[0].message.content;

            // Parse markdown and add AI message to UI
            addMessageToUI('assistant', parseMarkdown(aiMessage));
        } catch (error) {
            console.error('Error:', error);
            addMessageToUI('assistant', 'Sorry, I encountered an error while processing your request.');
        }
        }



        function addMessageToUI(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', role);
            messageDiv.innerHTML = `
                <div class="message-content">
                    ${content}
                </div>
            `;
            messageList.appendChild(messageDiv);
            messageList.scrollTop = messageList.scrollHeight;
        }

        // Add event listener for Enter key
userInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); // Prevent default to avoid line break
        sendMessage();
    }
});


function parseMarkdown(markdown) {
    // Convert code blocks with language specification
    markdown = markdown.replace(/```(\w+)\n([\s\S]*?)```/g, function(match, language, code) {
        return `<pre><code class="language-${language}">${escapeHTML(code.trim())}</code></pre>`;
    });
    
    // Convert code blocks without language specification
    markdown = markdown.replace(/```([\s\S]*?)```/g, function(match, code) {
        return `<pre><code>${escapeHTML(code.trim())}</code></pre>`;
    });
    
    // Convert headers
    markdown = markdown.replace(/^### (.*$)/gim, '<h3>$1</h3>');
    markdown = markdown.replace(/^## (.*$)/gim, '<h2>$1</h2>');
    markdown = markdown.replace(/^# (.*$)/gim, '<h1>$1</h1>');
    
    // Convert bold and italic
    markdown = markdown.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    markdown = markdown.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // Convert links
    markdown = markdown.replace(/\[([^\]]+)\]\(([^\)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
    
    // Convert inline code
    markdown = markdown.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    // Convert unordered lists
    markdown = markdown.replace(/^\s*[\-\*] (.*)$/gim, '<ul><li>$1</li></ul>');
    markdown = markdown.replace(/<\/ul><ul>/g, '');
    
    // Convert ordered lists
    markdown = markdown.replace(/^\s*\d+\. (.*)$/gim, '<ol><li>$1</li></ol>');
    markdown = markdown.replace(/<\/ol><ol>/g, '');
    
    // Convert paragraphs
    markdown = markdown.replace(/^(?!<[uo]l|<p|<h|<pre)(.*$)/gim, '<p>$1</p>');
    
    return markdown.trim();
}

// Helper function to escape HTML special characters
function escapeHTML(unsafe) {
    return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
}
    </script>
</body>
</html>